<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>用户管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, frontUser-scalable=0">
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">
</head>
<body>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto" lay-filter="search">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">生成时间</label>
                    <div class="layui-input-block">
                        <input id="genTime" name="genTime" placeholder="请输入" autocomplete="off" class="layui-input"
                               style="width: 300px;" readonly>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">账户</label>
                    <div class="layui-input-block">
                        <input name="accounts" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">名称</label>
                    <div class="layui-input-block">
                        <input name="name" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-order" lay-submit lay-filter="search">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="layui-card-body">
            <table id="tableBody" lay-filter="tableBody"></table>
        </div>
    </div>

    <!--表单内操作栏-->
    <script type="text/html" id="operator">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
    </script>

    <!--头部工具栏-->
    <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn" lay-event="add">添加</button>
        </div>
    </script>
</div>

<script src="../../layuiadmin/layui/layui.js"></script>
<script>
    layui.config({
        base: '../../layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'laydate', 'table'], function () {
        const $ = layui.$
            , form = layui.form
            , table = layui.table
            , laydate = layui.laydate
            , TIME_SPLIT = '至';

        //包装查询的时间类
        let timeData = {};

        //渲染主表单
        const tableIns = table.render({
            elem: '#tableBody'
            , url: 'list.ajax'
            , cols: [[
                {title: '账户', field: 'accounts'}
                , {title: '名称', field: 'name'}
                , {title: '更新时间', field: 'updTime'}
                , {title: '生成时间', field: 'genTime'}
                , {title: '最近登录', field: 'lastLoginTime'}
                , {title: '操作', templet: '#operator', width: 150}
            ]]
            , page: true
            , method: 'post'
            , request: {pageName: 'pageOffset', limitName: 'capacity'}
            , toolbar: '#toolbar'
        })

        //监听操作
        table.on('tool(tableBody)', obj => {
            switch (obj.event) {
                case 'edit':
                    edit(obj);
                    break;
                case 'del':
                    layer.confirm('确认删除？', () => {
                        deleteItem(obj);
                        // layer.close(i);
                    })
                    break;
                default:
                    console.error(obj.event);
            }
        })

        function deleteItem(obj) {
            $.post('del.ajax', {id: obj.data.ifrontUser}, res => {
                if (doResult(res)) obj.del();
            })
        }

        function doResult(res) {
            if (res.code === 0) {
                layer.msg(res.msg);
                return true;
            } else {
                layer.alert(res.msg);
                return false;
            }
        }


        // 监听工具栏
        table.on('toolbar(tableBody)', obj => {
            switch (obj.event) {
                case 'add':
                    add();
                    break;
                default:
                    console.error(obj.event);
            }
        })

        //添加
        function add() {
            layer.open({
                type: 2
                , title: '添加'
                , content: 'add.html'
                , area: ['500px', '450px']
                , btn: ['确定', '取消']
                , yes: function (index, layero) {
                    const iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'LAY-frontUser-front-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                    //监听提交
                    iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                        const field = data.field; //获取提交的字段
                        console.log('form data:', field)
                        //提交 Ajax 成功后，静态更新表格中的数据
                        //$.ajax({});

                        $.post('add.ajax', field, res => {
                            if (doResult(res)) {
                                tableIns.reload(); //数据刷新
                                layer.close(index); //关闭弹层
                            }
                        })

                    });
                    submit.trigger('click');
                }
            });
        }

        /**
         * 刷新单条记录
         * @param obj
         * @param field
         */
        function updateRow(obj, field) {
            for (const key in field) {
                obj.data[key] = field[key];
            }
            obj.update(obj.data);
        }

        //编辑单条记录
        function edit(obj) {
            layer.open({
                type: 2
                , title: '编辑'
                , content: 'edit.html'
                , area: ['500px', '450px']
                , btn: ['确定', '取消']
                , success(layero, index) {

                    //为子页面表单赋值
                    for (const key in obj.data) {
                        layero.find('iframe').contents().find('#' + key).val(obj.data[key]);
                    }

                }
                , yes(index, layero) {
                    const iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'LAY-frontUser-front-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                    //监听提交
                    iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                        const field = data.field; //获取提交的字段
                        //提交 Ajax 成功后，静态更新表格中的数据
                        $.post('update.ajax', field, res => {
                            if (doResult(res)) {
                                // tableIns.reload(); //全部数据刷新
                                updateRow(obj, field);//单条数据刷新
                                layer.close(index); //关闭弹层
                            }
                        })

                    });
                    submit.trigger('click');
                }
            });
        }

        //渲染时间控件
        laydate.render({
            elem: '#genTime'
            , type: 'datetime'
            , range: TIME_SPLIT,
            done(value, date, endDate) {
                // console.log(value); //得到日期生成的值，如：2017-08-18
                // console.log(date); //得到日期时间对象：{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}
                // console.log(endDate); //得结束的日期时间对象，开启范围选择（range: true）才会返回。对象成员同上。
                const times = value.split(TIME_SPLIT);
                timeData.startTime = times[0].trim();
                timeData.endTime = times[1].trim();
            }
        })

        form.on('submit(search)', data => {
            // console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
            // console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
            // console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}

            //复制timeData的开始时间和结束时间给查询的表单
            for (const key in timeData) {
                data.field[key] = timeData[key];
            }

            tableIns.reload({
                where: data.field
            })
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        })
    });
</script>
</body>
</html>